#!/usr/bin/env python3
"""
Test script for MCP servers
Tests each server individually to verify correct output.
"""

import asyncio
import json
import sys
from mcp import ClientSession
from mcp.client.streamable_http import streamablehttp_client


async def test_server(server_url: str, tool_name: str, arguments: dict):
    """Test a single MCP server tool."""
    print(f"\n{'='*60}")
    print(f"üîç Testing: {tool_name}")
    print(f"üì° Server: {server_url}")
    print(f"üì• Arguments: {json.dumps(arguments, ensure_ascii=False)}")
    print(f"{'='*60}")
    
    try:
        async with streamablehttp_client(f"{server_url}/") as (read, write, _):
            async with ClientSession(read, write) as session:
                await session.initialize()
                
                # List available tools
                tools_result = await session.list_tools()
                print(f"\nüìã Available tools: {[t.name for t in tools_result.tools]}")
                
                # Call the tool
                result = await session.call_tool(tool_name, arguments)
                
                if result.content:
                    response_text = result.content[0].text
                    try:
                        response_json = json.loads(response_text)
                        print(f"\n‚úÖ Response:")
                        print(json.dumps(response_json, ensure_ascii=False, indent=2))
                        return response_json
                    except json.JSONDecodeError:
                        print(f"\nüìÑ Raw Response: {response_text[:500]}")
                        return response_text
                else:
                    print("‚ùå No content in response")
                    return None
                    
    except Exception as e:
        print(f"‚ùå Error: {e}")
        return None


async def test_embedding_server():
    """Test embedding server tools."""
    print("\n" + "="*80)
    print("üß™ TESTING EMBEDDING SERVER (Port 5003)")
    print("="*80)
    
    # Test get_embedding
    result = await test_server(
        "http://localhost:5003",
        "get_embedding",
        {"text": "ÿ¥€åÿ± ⁄©ŸÖ ⁄Üÿ±ÿ® ⁄©ÿßŸÑŸá"}
    )
    
    if result and result.get("success"):
        embedding = result.get("embedding", [])
        print(f"\nüìä Embedding dimension: {len(embedding)}")
        print(f"üìä First 5 values: {embedding[:5]}")
    
    # Test classify_categories
    result = await test_server(
        "http://localhost:5003",
        "classify_categories",
        {"query": "ÿ¥Ÿàÿ±ÿ™ ÿµŸàÿ±ÿ™€å ŸÖÿ±ÿØÿßŸÜŸá xl", "top_k": 3}
    )
    
    return result


async def test_interpret_server():
    """Test interpret server with new output format."""
    print("\n" + "="*80)
    print("üß™ TESTING INTERPRET SERVER (Port 5004)")
    print("="*80)
    
    result = await test_server(
        "http://localhost:5004",
        "interpret_query",
        {"query": "ÿßÿ±ÿ≤ÿßŸÜ ÿ™ÿ±€åŸÜ ŸÑÿ®ÿ™ÿßÿ® ÿ±Ÿà ŸÖ€åÿÆŸàÿßŸÖ"}
    )
    
    if result:
        print("\nüìã Expected fields check:")
        expected_fields = [
            "equip_prompt",
            "persian_full_query", 
            "token_mapping",
            "categories_fa",
            "intent",
            "price_sensitivity",
            "quality_sensitivity"
        ]
        for field in expected_fields:
            status = "‚úÖ" if field in result else "‚ùå"
            print(f"  {status} {field}: {result.get(field, 'MISSING')}")
    
    return result


async def test_equip_server():
    """Test EQuIP server for DSL generation."""
    print("\n" + "="*80)
    print("üß™ TESTING EQUIP SERVER (Port 5005)")
    print("="*80)
    
    # First check status
    status = await test_server(
        "http://localhost:5005",
        "check_equip_status",
        {}
    )
    
    # Then test DSL generation
    result = await test_server(
        "http://localhost:5005",
        "generate_dsl",
        {
            "query": "product_name: doogh sort: price_asc",
            "intent": "find_cheapest"
        }
    )
    
    return result


async def test_dsl_processor_server():
    """Test DSL processor server."""
    print("\n" + "="*80)
    print("üß™ TESTING DSL PROCESSOR SERVER (Port 5006)")
    print("="*80)
    
    # Sample DSL from EQuIP (English)
    sample_dsl = {
    "query": {
      "bool": {
        "must": [
          {
            "multi_match": {
              "query": "doogh",
              "fields": [
                "product_name^3",
                "brand_name"
              ],
              "type": "best_fields"
            }
          }
        ],
        "filter": [
          {
            "terms": {
              "category_name.keyword": []
            }
          }
        ]
      }
    },
    "sort": [
      {
        "price": "asc"
      }
    ],
    "size": 50
  }
    
    token_mapping = {
        "doogh": "ÿØŸàÿ∫"
    }
    
    result = await test_server(
        "http://localhost:5006",
        "process_dsl",
        {
            "dsl": json.dumps(sample_dsl),
            "token_mapping": json.dumps(token_mapping),
            "persian_full_query": "ÿØŸàÿ∫",
            "categories_fa": json.dumps(["ŸÑÿ®ŸÜ€åÿßÿ™","ŸÜŸàÿ¥€åÿØŸÜ€å","ÿÆÿßŸÜŸá Ÿà ÿßÿ¥Ÿæÿ≤ÿÆÿßŸÜŸá"]),
            "add_semantic": True
        }
    )
    
    return result


async def test_search_server():
    """Test search server with execute_dsl."""
    print("\n" + "="*80)
    print("üß™ TESTING SEARCH SERVER (Port 5002)")
    print("="*80)
    
    # Sample processed DSL (Persian)
    sample_dsl = {
    "query": {
      "bool": {
        "must": [
          {
            "multi_match": {
              "query": "ÿØŸàÿ∫",
              "fields": [
                "product_name^3",
                "brand_name"
              ],
              "type": "best_fields"
            }
          }
        ],
        "filter": [
          {
            "terms": {
              "category_name.keyword": [
                "ŸÑÿ®ŸÜ€åÿßÿ™",
                "ŸÜŸàÿ¥€åÿØŸÜ€å",
                "ÿÆÿßŸÜŸá Ÿà ÿßÿ¥Ÿæÿ≤ÿÆÿßŸÜŸá"
              ]
            }
          }
        ],
        "should": [
          {
            "match_phrase": {
              "product_name": {
                "query": "ÿØŸàÿ∫",
                "boost": 3.0
              }
            }
          },
          {
            "multi_match": {
              "query": "ÿØŸàÿ∫",
              "fields": [
                "product_name^2",
                "brand_name",
                "category_name"
              ],
              "type": "best_fields",
              "operator": "or",
              "boost": 1.5
            }
          },
          {
            "script_score": {
              "query": {
                "match_all": {}
              },
              "script": {
                "source": "cosineSimilarity(params.query_vector, 'product_embedding') + 1.0",
                "params": {
                  "query_vector": [
                    0.008314766921103,
                    0.03293445706367493,
                    -0.018265068531036377,
                    0.02219265140593052,
                    0.010288216173648834,
                    -0.06773103773593903,
                    -0.014689577743411064,
                    -0.056137245148420334,
                    0.025006134063005447,
                    0.03610296547412872,
                    -0.04487737640738487,
                    0.00011545162124093622,
                    0.16246339678764343,
                    0.05009549483656883,
                    -0.02147788554430008,
                    -0.08644339442253113,
                    0.032272983342409134,
                    0.007684024516493082,
                    0.052726928144693375,
                    0.006211143918335438,
                    0.06943485140800476,
                    -0.013393952511250973,
                    0.03354723006486893,
                    -0.017750117927789688,
                    0.01646721176803112,
                    -0.03440380096435547,
                    0.05538009852170944,
                    0.014210538938641548,
                    -0.015597432851791382,
                    0.019788043573498726,
                    0.02429073676466942,
                    -0.011114504188299179,
                    0.036514826118946075,
                    -0.011443761177361012,
                    -0.0036365496926009655,
                    -0.0029540422838181257,
                    0.005034673493355513,
                    -0.03771580383181572,
                    0.04708234220743179,
                    -0.018861494958400726,
                    0.018108544871211052,
                    0.025904210284352303,
                    0.016018029302358627,
                    -0.06190776079893112,
                    0.04823200777173042,
                    -0.013804311864078045,
                    0.006525618489831686,
                    -0.005745842587202787,
                    -0.013778476975858212,
                    -0.04050033167004585,
                    0.013186226598918438,
                    0.0293266698718071,
                    0.0151201281696558,
                    0.009556833654642105,
                    -0.06285493820905685,
                    -0.05560465529561043,
                    0.024170877411961555,
                    0.049887996166944504,
                    -0.052118346095085144,
                    0.03002282977104187,
                    -0.004342598374933004,
                    -0.0002613659598864615,
                    -0.011745468713343143,
                    0.004215297754853964,
                    0.04358348250389099,
                    -0.007282106205821037,
                    0.012905171141028404,
                    -0.02521667629480362,
                    -0.043418578803539276,
                    -0.04316552355885506,
                    -0.006987342145293951,
                    0.007652990520000458,
                    0.049960535019636154,
                    0.014514965936541557,
                    -0.041857682168483734,
                    -0.015588294714689255,
                    -0.04407701641321182,
                    0.029185552150011063,
                    -0.02188955433666706,
                    -0.027077002450823784,
                    0.02793373540043831,
                    0.011192508973181248,
                    0.044550783932209015,
                    -0.010560182854533195,
                    0.021299734711647034,
                    -0.02415500581264496,
                    -0.014587879180908203,
                    0.03667154163122177,
                    0.03278011456131935,
                    0.0661584809422493,
                    0.04188457503914833,
                    -0.02558688446879387,
                    -0.055749405175447464,
                    0.03290823474526405,
                    0.02736714482307434,
                    0.0005359210772439837,
                    0.02324364148080349,
                    -0.019021781161427498,
                    0.018794601783156395,
                    -0.06280466169118881,
                    -0.01777425967156887,
                    -0.09934792667627335,
                    -0.03559410199522972,
                    -0.025611212477087975,
                    -0.06164296343922615,
                    -0.012063917703926563,
                    -0.03491666540503502,
                    -0.04039723798632622,
                    0.014009229838848114,
                    -0.050387218594551086,
                    -0.014872261323034763,
                    0.008678211830556393,
                    0.011134018190205097,
                    -0.07044318318367004,
                    0.014647205360233784,
                    -0.004304192494601011,
                    -0.0301472470164299,
                    -0.025954049080610275,
                    0.0008784504025243223,
                    -0.013353470712900162,
                    0.010601989924907684,
                    0.022437850013375282,
                    -0.014263917692005634,
                    -0.011249528266489506,
                    0.05347340926527977,
                    -0.024734841659665108,
                    0.016388684511184692,
                    0.0005137557163834572,
                    0.03988606110215187,
                    -0.03086134046316147,
                    0.014690248295664787,
                    -0.10412833839654922,
                    0.015480644069612026,
                    -0.0007937820628285408,
                    -0.014132463373243809,
                    0.0105685293674469,
                    0.017887890338897705,
                    0.029745327308773994,
                    0.02165122888982296,
                    -0.015919024124741554,
                    0.07519672811031342,
                    -0.03656507283449173,
                    0.024119872599840164,
                    0.029373086988925934,
                    0.016420826315879822,
                    -0.05385137349367142,
                    0.020705919712781906,
                    -0.010966292582452297,
                    -0.027094587683677673,
                    0.013999847695231438,
                    0.014234895817935467,
                    -0.05702061206102371,
                    -0.027575349435210228,
                    -0.052012164145708084,
                    0.02694006823003292,
                    -0.015260644257068634,
                    -0.07630029320716858,
                    -0.021602945402264595,
                    0.01194671355187893,
                    0.029312679544091225,
                    0.02806968055665493,
                    0.026454482227563858,
                    -0.008860005997121334,
                    -0.01269109919667244,
                    0.03653834015130997,
                    -0.004650580696761608,
                    -0.015725431963801384,
                    0.008959545753896236,
                    -0.025848815217614174,
                    -0.03176500275731087,
                    -0.01651577278971672,
                    -0.005713731050491333,
                    -0.06355118751525879,
                    0.0036287878174334764,
                    0.021541893482208252,
                    -0.022781142964959145,
                    -0.01978333853185177,
                    -0.010327961295843124,
                    -0.028213677927851677,
                    -0.045869145542383194,
                    0.041694656014442444,
                    -0.027496062219142914,
                    -0.023674653843045235,
                    0.04590275138616562,
                    -0.01496874913573265,
                    0.0011824548710137606,
                    0.000734697503503412,
                    -0.02885754033923149,
                    0.044869307428598404,
                    0.0022601184900850058,
                    -0.00952147226780653,
                    0.055290549993515015,
                    0.05336747691035271,
                    0.0250549353659153,
                    0.028506139293313026,
                    0.022024808451533318,
                    -0.006410217843949795,
                    0.00935155525803566,
                    -0.02260752208530903,
                    -0.02950170636177063,
                    0.02430770918726921,
                    -0.03935272619128227,
                    0.058321863412857056,
                    0.019280239939689636,
                    0.029286086559295654,
                    -0.08035338670015335,
                    0.034086987376213074,
                    0.027720563113689423,
                    0.008646986447274685,
                    0.016407659277319908,
                    0.010013253428041935,
                    0.01952730119228363,
                    -0.037088364362716675,
                    0.027231018990278244,
                    -0.0330936536192894,
                    -0.02267160825431347,
                    0.06279972195625305,
                    0.05025563761591911,
                    -0.033596813678741455,
                    0.045013654977083206,
                    0.026638176292181015,
                    -0.026039594784379005,
                    0.06675130128860474,
                    -0.0038556891959160566,
                    -0.017334390431642532,
                    0.006988404784351587,
                    0.019553132355213165,
                    -0.002884749323129654,
                    0.005521500948816538,
                    0.046923089772462845,
                    0.0004008934192825109,
                    0.04872942343354225,
                    -0.014276177622377872,
                    0.030452050268650055,
                    -0.0395541712641716,
                    0.0029847370460629463,
                    0.03777334839105606,
                    -0.015983330085873604,
                    -0.0019888971000909805,
                    -0.10843644291162491,
                    -0.033536992967128754,
                    0.006966464687138796,
                    0.02294234186410904,
                    5.42091038369108e-05,
                    0.013047732412815094,
                    -0.02487904019653797,
                    -0.056594375520944595,
                    0.03735300526022911,
                    -0.04874241724610329,
                    -0.01155228540301323,
                    -0.03317979723215103,
                    -0.028090203180909157,
                    0.02738351933658123,
                    2.847964788088575e-05,
                    0.009110837243497372,
                    0.03346531093120575,
                    -0.0036652882117778063,
                    0.05136272683739662,
                    -0.05332079157233238,
                    0.023897359147667885,
                    0.017981508746743202,
                    -0.02331756427884102,
                    -0.022375939413905144,
                    0.023919811472296715,
                    0.03757592663168907,
                    0.024153178557753563,
                    0.04985303431749344,
                    -0.04197648540139198,
                    -0.04222549498081207,
                    -0.006757241208106279,
                    -0.014378523454070091,
                    -0.0034719156101346016,
                    -0.03423971310257912,
                    0.03670526295900345,
                    0.014101892709732056,
                    -0.03608043119311333,
                    -0.046134427189826965,
                    -0.008196032606065273,
                    -0.016111526638269424,
                    -0.008076074533164501,
                    -0.02035561017692089,
                    0.04016251489520073,
                    -0.027535565197467804,
                    -0.023589951917529106,
                    -0.02917877770960331,
                    -0.0004899800405837595,
                    -0.056557610630989075,
                    -0.010940936394035816,
                    -0.039364803582429886,
                    0.06020278111100197,
                    0.037418439984321594,
                    0.024966267868876457,
                    -0.015282531268894672,
                    0.029614470899105072,
                    0.05614175274968147,
                    0.035758551210165024,
                    0.01893770694732666,
                    0.03866218775510788,
                    -0.011171403340995312,
                    0.027042293921113014,
                    0.00047220513806678355,
                    -0.0033516932744532824,
                    0.03140627220273018,
                    -0.034239258617162704,
                    -0.029719535261392593,
                    0.02513183280825615,
                    0.10805874317884445,
                    0.017250917851924896,
                    -0.08321432024240494,
                    0.05289042368531227,
                    -0.028369111940264702,
                    -0.018127193674445152,
                    -0.040006715804338455,
                    -0.005344596691429615,
                    -0.010359534062445164,
                    0.03601016476750374,
                    0.032473124563694,
                    0.07027097791433334,
                    -0.0031794582027941942,
                    0.04951157048344612,
                    -0.014517052099108696,
                    0.04516929015517235,
                    -0.01111376378685236,
                    -0.02158653549849987,
                    0.013570570386946201,
                    -0.02354005165398121,
                    0.03545089438557625,
                    0.017733918502926826,
                    0.026973288506269455,
                    0.008916961029171944,
                    -0.00421048142015934,
                    0.029221350327134132,
                    -0.019849706441164017,
                    0.03862622007727623,
                    -0.103134386241436,
                    -0.01931357942521572,
                    -0.04991798475384712,
                    -0.025339338928461075,
                    0.03961530327796936,
                    0.016737982630729675,
                    -0.006867291405797005,
                    0.04462519660592079,
                    -0.019574740901589394,
                    -0.026010239496827126,
                    0.034517478197813034,
                    -0.039334412664175034,
                    -0.010768229141831398,
                    -0.025773078203201294,
                    -0.009746501222252846,
                    0.028217339888215065,
                    0.01751873642206192,
                    -0.07651200145483017,
                    -0.005643590819090605,
                    -0.010483118705451488,
                    -0.027494793757796288,
                    -0.011199206113815308,
                    0.034291110932826996,
                    -0.01878928579390049,
                    -0.028555236756801605,
                    -0.007282202132046223,
                    -0.021598082035779953,
                    0.032070860266685486,
                    -0.008512979373335838,
                    0.029707636684179306,
                    0.04925436154007912,
                    0.040114544332027435,
                    -0.04449211433529854,
                    -0.019251130521297455,
                    0.0351376086473465,
                    -0.004593664314597845,
                    0.07597025483846664,
                    0.02166697010397911,
                    -0.027136344462633133,
                    -0.0002808368590194732,
                    0.025049231946468353,
                    -0.03211816027760506,
                    0.008770236745476723,
                    -0.04688820242881775,
                    -0.004548010416328907,
                    -0.0018137498991563916,
                    0.04724521562457085,
                    0.027766428887844086,
                    0.030144410207867622,
                    0.04043165594339371,
                    -0.029866373166441917,
                    0.004408074542880058,
                    0.0028319312259554863,
                    -0.03891139104962349,
                    0.0674864649772644,
                    0.018122751265764236,
                    0.0010717319091781974,
                    -0.0774773508310318,
                    -0.04471529275178909,
                    -0.0032250271178781986,
                    0.04291333630681038,
                    -0.03875404968857765,
                    0.03616337478160858,
                    -0.011402422562241554,
                    0.012718766927719116,
                    -0.02347959578037262,
                    0.044458191841840744,
                    0.012769859284162521,
                    0.0019197758520022035,
                    -0.012923416681587696,
                    0.017494702711701393,
                    0.057088159024715424,
                    0.004999171011149883,
                    0.03997407853603363,
                    -0.0019552051089704037,
                    -0.03212940692901611,
                    0.054122790694236755,
                    0.010892831720411777,
                    0.03590325638651848,
                    -0.03877292945981026,
                    0.007790279109030962,
                    0.0013311010552570224,
                    -0.027266159653663635,
                    0.05281541123986244,
                    0.016553236171603203,
                    0.019567418843507767,
                    -0.023424828425049782,
                    0.01548831257969141,
                    0.005338269751518965,
                    0.05347504839301109,
                    0.034501343965530396,
                    -0.07537909597158432,
                    -0.0420161634683609,
                    -0.03804869204759598,
                    0.014808843843638897,
                    -0.024869022890925407,
                    -0.0015624483348801732,
                    0.005291569512337446,
                    -0.010155868716537952,
                    0.02701425738632679,
                    0.02416318468749523,
                    -0.05725626274943352,
                    -0.007246857974678278,
                    0.009039144963026047,
                    0.009382184594869614,
                    0.01123200636357069,
                    -0.027318798005580902,
                    -0.01333649642765522,
                    0.018705319613218307,
                    0.011240706779062748,
                    -0.027219194918870926,
                    -0.022640878334641457,
                    -0.05654749646782875,
                    -0.00887714046984911,
                    -0.04928279295563698,
                    -0.027268074452877045,
                    0.06112595647573471,
                    0.024789495393633842,
                    0.009364038705825806,
                    0.02029154635965824,
                    0.018422260880470276,
                    -0.02105615846812725,
                    0.004131247755140066,
                    -0.02621513232588768,
                    0.040512412786483765,
                    -0.10714763402938843,
                    0.04318975284695625,
                    0.019095079973340034,
                    -0.007769813761115074,
                    -0.006411116570234299,
                    -0.12591652572155,
                    -0.03792848810553551,
                    0.02413463033735752,
                    -0.045267555862665176,
                    0.03459177911281586,
                    -0.02328634075820446,
                    -0.008852439932525158,
                    -0.023624256253242493,
                    0.03522792086005211,
                    -0.021858125925064087,
                    0.054660048335790634,
                    0.02359982766211033,
                    0.025723665952682495,
                    0.06564939767122269,
                    0.03519231081008911,
                    -0.031187618151307106,
                    -0.019086338579654694,
                    -0.003492913208901882,
                    -0.08562400937080383,
                    0.008649257943034172,
                    0.062957763671875,
                    0.04311969503760338,
                    -0.10800725966691971,
                    0.006900693755596876,
                    0.02810395509004593,
                    -0.036301542073488235,
                    0.018293287605047226,
                    0.055023472756147385,
                    0.004232142586261034,
                    -0.0011693739797919989,
                    0.036470137536525726,
                    0.0368821807205677,
                    -0.0311884768307209,
                    -0.052248820662498474,
                    0.030078107491135597,
                    0.00928611122071743,
                    -0.001766050816513598,
                    -0.03857877850532532,
                    -0.030707381665706635,
                    -0.01339775137603283,
                    0.012390847317874432,
                    0.04913133755326271,
                    -0.015581510961055756,
                    -0.012266670353710651,
                    0.037020716816186905,
                    -0.005816596560180187,
                    0.0504731647670269,
                    -0.03373139724135399,
                    -0.00024075167311821133,
                    -0.03926729038357735,
                    -0.007082663010805845,
                    0.042188286781311035,
                    -0.020083343610167503,
                    0.025687184184789658,
                    0.0048360805958509445,
                    -0.03547075763344765,
                    -0.011134618893265724,
                    0.012711947783827782,
                    -0.016387775540351868,
                    -0.05297946557402611,
                    0.0731605514883995,
                    -0.0446801520884037,
                    0.013263876549899578,
                    0.00355528830550611,
                    0.01563788577914238,
                    -0.06036660820245743,
                    0.056978628039360046,
                    -0.01650107093155384,
                    0.0031246424186974764,
                    -0.08810729533433914,
                    -0.052509184926748276,
                    0.018529806286096573,
                    -0.019043339416384697,
                    -0.013994541950523853,
                    0.046787992119789124,
                    0.0020309523679316044,
                    -0.0245814248919487,
                    -0.030347472056746483,
                    0.025248780846595764,
                    -0.012761141173541546,
                    0.037270329892635345,
                    -0.03651163727045059,
                    -0.008427183143794537,
                    -0.01858522556722164,
                    0.03243158385157585,
                    -0.007870886474847794,
                    0.07414548099040985,
                    0.003279599593952298,
                    -0.011237169615924358,
                    0.039273228496313095,
                    -0.07588017731904984,
                    0.01983688399195671,
                    -0.002860946347936988,
                    0.006313665304332972,
                    0.02992478758096695,
                    -0.013269168324768543,
                    0.0135098397731781,
                    -0.034462571144104004,
                    0.0024973398540169,
                    0.04038962721824646,
                    -0.018439970910549164,
                    0.02738124318420887,
                    0.026999622583389282,
                    -0.018792975693941116,
                    -0.03389081731438637,
                    0.09440083801746368,
                    -0.08197659254074097,
                    0.00523391691967845,
                    0.03893279284238815,
                    -0.0416409894824028,
                    0.02237723022699356,
                    0.010342591442167759,
                    -0.035760801285505295,
                    -0.04240009933710098,
                    0.03272794187068939,
                    -0.03365878388285637,
                    -0.023506827652454376,
                    -0.013479338027536869,
                    -0.06070173531770706,
                    0.03640116751194,
                    0.05845670402050018,
                    0.030096564441919327,
                    0.025132695212960243,
                    -0.05938427895307541,
                    -0.18936462700366974,
                    0.0036070160567760468,
                    -0.04965643212199211,
                    -0.056374188512563705,
                    0.04158434644341469,
                    0.04763558506965637,
                    0.013841398060321808,
                    -0.020715735852718353,
                    0.015950968489050865,
                    0.02623761259019375,
                    0.039825137704610825,
                    -0.018356485292315483,
                    0.015157628804445267,
                    -0.0063024116680026054,
                    -0.02819296345114708,
                    0.011266198940575123,
                    -0.01533835381269455,
                    0.007545803673565388,
                    0.07344866544008255,
                    -0.010569422505795956,
                    -0.0030026952736079693,
                    0.021857790648937225,
                    -0.01315327174961567,
                    -0.007717176340520382,
                    0.001060038572177291,
                    -0.03859272599220276,
                    -0.005604895297437906,
                    -0.002684179460629821,
                    0.03321908786892891,
                    0.04172712564468384,
                    0.016027793288230896,
                    0.0440850667655468,
                    0.025516605004668236,
                    0.017403969541192055,
                    -0.007374847773462534,
                    -0.007371170446276665,
                    -0.04287998005747795,
                    0.005151081830263138,
                    -0.06528370827436447,
                    0.03220067173242569,
                    0.007317810319364071,
                    -0.0612541064620018,
                    -0.020421089604496956,
                    0.03973208740353584,
                    0.0014048242010176182,
                    0.008366524241864681,
                    0.06820377707481384,
                    0.023570043966174126,
                    -0.0475417859852314,
                    -0.04725077375769615,
                    0.02544189989566803,
                    0.003658764064311981,
                    -0.1095309928059578,
                    0.010538306087255478,
                    -0.07078072428703308,
                    0.036802954971790314,
                    0.03241991251707077,
                    0.04385749623179436,
                    0.016192151233553886,
                    -0.08683932572603226,
                    0.005821146070957184,
                    0.017958058044314384,
                    -0.020786505192518234,
                    0.05642012879252434,
                    -0.00875912420451641,
                    -0.04584873467683792,
                    -0.014081573113799095,
                    -0.006652274169027805,
                    -0.013532946817576885,
                    0.014558671973645687,
                    0.056531667709350586,
                    -0.024505402892827988,
                    -0.021310847252607346,
                    0.07079111039638519,
                    0.03086838684976101,
                    -0.011469889432191849,
                    0.008445464074611664,
                    -0.03633841127157211,
                    -0.07678855210542679,
                    0.007224429864436388,
                    0.016441455110907555,
                    -0.051544398069381714,
                    -0.012236728332936764,
                    0.013238831423223019,
                    -0.026658711954951286,
                    -0.031329039484262466,
                    -0.012821631506085396,
                    0.01464301347732544,
                    0.015821639448404312,
                    0.055334385484457016,
                    -0.045539695769548416,
                    -0.04356631264090538,
                    -0.009901578538119793,
                    0.006467887666076422,
                    0.04527920484542847,
                    -0.010886394418776035,
                    0.006159422919154167,
                    0.019407223910093307,
                    0.004724645055830479,
                    -0.01494545303285122,
                    0.014622939750552177,
                    -0.021534278988838196,
                    -0.007249017246067524,
                    0.04416121914982796,
                    0.029133109375834465,
                    -0.01597638614475727,
                    -0.09539279341697693,
                    0.045665089040994644,
                    0.0021969927474856377,
                    -0.048567596822977066,
                    0.029903970658779144,
                    0.017892200499773026,
                    0.0648215264081955,
                    -0.025966692715883255,
                    -0.005416551139205694,
                    -0.005387410055845976,
                    0.03248267620801926,
                    0.006438529584556818,
                    -0.03655298054218292,
                    -0.046184174716472626,
                    -0.037167493253946304,
                    -0.051279425621032715,
                    0.003135165199637413,
                    -0.02954864129424095,
                    0.0340067483484745,
                    -0.008812414482235909,
                    0.004467130172997713,
                    0.059893835335969925,
                    0.03217659145593643,
                    0.0005550231435336173,
                    -0.020403413102030754,
                    -0.0452139787375927,
                    -0.0046784947626292706,
                    0.0021037347614765167,
                    -0.0054462929256260395,
                    0.0700790286064148,
                    0.04024016484618187,
                    -0.0013621803373098373,
                    0.03405867889523506,
                    0.04332578182220459,
                    0.056523799896240234,
                    -0.09522611647844315,
                    0.008441810496151447,
                    0.019661320373415947,
                    -0.03030669502913952,
                    0.015016352757811546,
                    0.03333446383476257,
                    -0.028805362060666084,
                    0.02162148617208004,
                    -0.0004900668864138424,
                    0.015145160257816315,
                    -0.04977912828326225,
                    -0.022995326668024063,
                    -0.020714171230793,
                    -0.021002264693379402,
                    0.0466625913977623,
                    -0.009268327616155148,
                    0.004899467807263136,
                    -0.07326572388410568,
                    0.038361892104148865,
                    -0.034207236021757126,
                    -0.06098456308245659,
                    0.01294897310435772,
                    0.024659642949700356,
                    0.038855236023664474,
                    0.013483736664056778,
                    -0.002178429625928402,
                    -0.014998180791735649,
                    -0.020126720890402794,
                    0.048107996582984924,
                    -0.022771690040826797,
                    0.04080668464303017,
                    0.027806129306554794,
                    0.02066390961408615,
                    0.04243076592683792,
                    0.010064761154353619,
                    0.013230178505182266,
                    -0.019700966775417328,
                    -0.02136414684355259,
                    0.002296406775712967
                  ]
                }
              },
              "boost": 2.0
            }
          }
        ],
        "minimum_should_match": 1
      }
    },
    "sort": [
      {
        "price": "asc"
      }
    ],
    "size": 50
  }
    
    result = await test_server(
        "http://localhost:5002",
        "execute_dsl",
        {
            "dsl": json.dumps(sample_dsl),
            "intent": "find_cheapest",
            "price_sensitivity": 1.0,
            "quality_sensitivity": 0.0
        }
    )
    
    return result


async def test_search_with_interpretation():
    """Test search_with_interpretation tool - the main pipeline."""
    print("\n" + "="*80)
    print("üß™ TESTING SEARCH WITH INTERPRETATION (Port 5002)")
    print("="*80)
    
    # Simulated interpret_server output
    equip_prompt = "product_name: doogh sort: price_asc"
    token_mapping = {"doogh": "ÿØŸàÿ∫"}
    persian_full_query = "ÿØŸàÿ∫"
    categories_fa = ["ŸÑÿ®ŸÜ€åÿßÿ™", "ŸÜŸàÿ¥€åÿØŸÜ€å"]
    
    result = await test_server(
        "http://localhost:5002",
        "search_with_interpretation",
        {
            "equip_prompt": equip_prompt,
            "token_mapping": json.dumps(token_mapping),
            "persian_full_query": persian_full_query,
            "categories_fa": json.dumps(categories_fa),
            "intent": "find_cheapest",
            "price_sensitivity": 1.0,
            "quality_sensitivity": 0.0
        }
    )
    
    if result:
        products = result.get("products", [])
        print(f"\nüìä Found {len(products)} products")
        if products:
            print("\nüîù Top 3 products:")
            for i, p in enumerate(products[:3], 1):
                print(f"   {i}. {p.get('name', 'N/A')} - {p.get('final_price', 0):,} ÿ™ŸàŸÖÿßŸÜ")
    
    return result


async def main():
    """Run all tests."""
    print("\n" + "üöÄ"*40)
    print("       MCP SERVERS TEST SUITE")
    print("üöÄ"*40)
    
    if len(sys.argv) > 1:
        test_name = sys.argv[1].lower()
        if test_name == "embedding":
            await test_embedding_server()
        elif test_name == "interpret":
            await test_interpret_server()
        elif test_name == "equip":
            await test_equip_server()
        elif test_name == "dsl":
            await test_dsl_processor_server()
        elif test_name == "search":
            await test_search_server()
        elif test_name == "pipeline":
            await test_search_with_interpretation()
        else:
            print(f"Unknown test: {test_name}")
            print("Available: embedding, interpret, equip, dsl, search, pipeline")
    else:
        # Run all tests
        print("\n‚ö†Ô∏è  Running all tests. Make sure all servers are running!")
        print("   - embedding_server (5003)")
        print("   - interpret_server (5004)")
        print("   - equip_server (5005)")
        print("   - dsl_processor_server (5006)")
        print("   - search_server (5002)")
        
        await test_embedding_server()
        await test_interpret_server()
        await test_equip_server()
        await test_dsl_processor_server()
        await test_search_server()
        await test_search_with_interpretation()
    
    print("\n" + "="*80)
    print("‚úÖ All tests completed!")
    print("="*80)


if __name__ == "__main__":
    asyncio.run(main())
